### 如何保证接口幂等性?

#### **什么是幂等**

幂等(idempotency)本身是一个数学概念，常见于抽象代数中，表示一个函数或者操作的结果不受其输入或者执行次数的影响。例如，f(n)=1^n，无论n为多少，f(n)的值永远为 1。

在软件开发领域，幂等是对请求操作结果的一个描述，这个描述就是不论执行多少次相同的请求，产生的效果和返回的结果都和发出单个请求是一样的。

针对数据操作来说就是:

- insert 操作要保证不插入重复的数据
- update 操作要保证多次相同请求数据依然正确。

接口幂等性问题通常是由于网络波动、用户重复操作、超时重试、消息重复消费、响应速度慢等原因导致的。



#### **不保证幂等性会怎么样？**

没有保证幂等会导致产生严重的生产级别的 Bug，比较典型的就是涉及到钱的业务场景。就比如在没有保证幂等性的情况下，我作为用户在付款的时候，我同时点击了多次付款按钮，后端处理了多次相同的扣款请求，结果导致我的账户被扣了多次钱。

这就是属于非常非常非常严重的 Bug 了!只要业务涉及到钱就一定要格外注意
综上，保证接口的幂等性至关重要。另外，保证幂等性这个 操作并不是说前端做了就可以的，后端同样也要做。





#### **如何保证幂等性？**

前端保证幂等性的话比较简单，一般通过当用户提交请求后将按钮致灰来做到。

后端保证幂等性就稍微麻烦一点，方法也是有很多种，比如悲观锁、乐观锁 、唯一索引、去重表、分布式锁、Token 机制等等。

悲观锁和分布式锁的核心思想都是通过加锁来保证同一时刻只有一个请求能被执行。但仅仅这样是不够的，还需要配合根据业务逻辑进行幂等性判断，例如，注册场景检测指定的电话/邮箱/用户名是否已经被注册、订单支付场景检测订单的状态。

实际项目中，一般采用分布式锁这种方案比较多。





#### **Token 机制**

Token 机制的核心思想是为每一次操作生成一个唯一性的凭证 token。这个 token 需要由服务端生成的，因为服务端可以对 token 进行签名和加密，防止篡改和泄露。如果由客户端生成 token，可能会存在安全隐患，比如客户端伪造或重复 token，导致服务端无法识别和校验，

这样的话，就需要两次请求才能完成一次业务操作:
1、请求获取服务器端 token，token 需要设置有效时间(可以设置短一点)，服务端将该 token 保存起来(通常保存在缓存中)

2、执行真正的请求，将上一步获取到的 token 放到 header 或者作为请求参数。服务端验证 token 的有效性，如果有效(一般是通过删除 token 的方式来验证，删除成功则有效)，执行业务逻辑，并删除token，防止重复提交；如果无效，拒绝请求，返回提示信息。

<img src="https://palepics.oss-cn-guangzhou.aliyuncs.com/img/image-20240409192613824.png" alt="image-20240409192613824" style="zoom: 67%;" />

























